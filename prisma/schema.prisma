// ì»¬ëŸ¼ëª…ì€ DBì—ì„œ snake_caseë¡œ ì €ì¥! (@map ì‚¬ìš©)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// ENUMS (ìƒíƒœê°’ ì •ì˜)
// -----------------------------------------------------------------------------

/// ìŠ¤í„°ë”” ë©¤ë²„ ê¶Œí•œ (ë°©ì¥ or ë©¤ë²„)
enum StudyMemberRole {
  OWNER
  MEMBER
}

/// ì§‘ì¤‘ ì„¸ì…˜ ì§„í–‰ ìƒíƒœ (ì§„í–‰ì¤‘ or ëª©í‘œ ë‹¬ì„± ì™„ë£Œ or ì¤‘ê°„ì— ì¤‘ë‹¨í•¨)
enum FocusSessionStatus {
  RUNNING
  COMPLETED
  STOPPED
}

/// ìŠ¤í„°ë”” ì¹´ë“œ ë°°ê²½ ì´ë¯¸ì§€ ì¢…ë¥˜
enum StudyBackgroundKey {
  green
  yellow
  blue
  pink
  workspace_1
  workspace_2
  pattern
  leaf
}

// -----------------------------------------------------------------------------
// ğŸ“‹ MODELS (í…Œì´ë¸” ì •ì˜)
// -----------------------------------------------------------------------------

/// ğŸ“‹ ì‚¬ìš©ì ì •ë³´ í…Œì´ë¸”
model User {
  id           String @id @default(uuid()) @db.Uuid
  email        String @unique @db.VarChar(255)
  nickname     String @db.VarChar(50)
  passwordHash String @map("password_hash") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ê´€ê³„
  ownedStudies        Study[]               @relation("StudyOwner")
  studyMembers        StudyMember[]
  habitChecks         HabitCheck[]
  focusSessions       FocusSession[]
  pointLogs           PointLog[]
  posts               Post[]
  postLikes           PostLike[]
  postComments        PostComment[]
  studyComments       StudyComment[]
  studyEmojiReactions StudyEmojiReaction[]

  @@map("users")
}

/// ğŸ“‹ ìŠ¤í„°ë”” í…Œì´ë¸”
model Study {
  id            String            @id @default(uuid()) @db.Uuid
  ownerId       String            @map("owner_id") @db.Uuid
  name          String            @db.VarChar(100)
  introduce     String            @db.Text
  backgroundKey StudyBackgroundKey @map("background_key")
  isPublic      Boolean            @default(true) @map("is_public")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // ê´€ê³„
  owner               User                 @relation("StudyOwner", fields: [ownerId], references: [id], onDelete: Restrict)
  studyMembers        StudyMember[]
  habits              Habit[]
  habitChecks         HabitCheck[]
  focusSessions       FocusSession[]
  pointLogs           PointLog[]
  studyEmojiReactions StudyEmojiReaction[]
  studyComments       StudyComment[]

  @@index([ownerId], map: "idx_studies_owner_id")
  @@map("studies")
}

/// ğŸ“‹ ìŠ¤í„°ë”” ë©¤ë²„ ê°€ì… ë‚´ì—­ í…Œì´ë¸”
model StudyMember {
  id       String          @id @default(uuid()) @db.Uuid
  studyId  String          @map("study_id") @db.Uuid
  userId   String          @map("user_id") @db.Uuid
  role     StudyMemberRole
  joinedAt DateTime        @default(now()) @map("joined_at")

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([studyId, userId], map: "uq_study_members_study_id_user_id")
  @@index([userId], map: "idx_study_members_user_id")
  @@index([studyId], map: "idx_study_members_study_id")
  @@map("study_members")
}

/// ğŸ“‹ ìŠ¤í„°ë””ë³„ ìŠµê´€ í•­ëª© í…Œì´ë¸”
model Habit {
  id      String @id @default(uuid()) @db.Uuid
  studyId String @map("study_id") @db.Uuid
  name    String @db.VarChar(100)

  createdAt DateTime  @default(now()) @map("created_at")
  endedAt   DateTime? @map("ended_at")

  // ê´€ê³„
  study       Study        @relation(fields: [studyId], references: [id], onDelete: Cascade)
  habitChecks HabitCheck[]

  @@index([studyId], map: "idx_habits_study_id")
  @@map("habits")
}

/// ğŸ“‹ ìŠµê´€ ë‹¬ì„± ì²´í¬ í…Œì´ë¸”
model HabitCheck {
  id      String @id @default(uuid()) @db.Uuid
  habitId String @map("habit_id") @db.Uuid
  studyId String @map("study_id") @db.Uuid
  userId  String @map("user_id") @db.Uuid

  date   DateTime @db.Date
  isDone Boolean  @default(true) @map("is_done")

  createdAt DateTime @default(now()) @map("created_at")

  // ê´€ê³„
  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([habitId, userId, date], map: "uq_habit_checks_habit_id_user_id_date")
  @@index([studyId, date], map: "idx_habit_checks_study_id_date")
  @@index([userId, date], map: "idx_habit_checks_user_id_date")
  @@map("habit_checks")
}

/// ğŸ“‹ ì§‘ì¤‘ ì‹œê°„ ê¸°ë¡ í…Œì´ë¸”
model FocusSession {
  id             String             @id @default(uuid()) @db.Uuid
  studyId        String             @map("study_id") @db.Uuid
  userId         String             @map("user_id") @db.Uuid
  targetSeconds  Int                @map("target_seconds")
  startedAt      DateTime           @map("started_at")
  endedAt        DateTime?          @map("ended_at")
  elapsedSeconds Int?               @map("elapsed_seconds")
  status         FocusSessionStatus

  createdAt DateTime @default(now()) @map("created_at")

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([studyId, startedAt], map: "idx_focus_sessions_study_id_started_at")
  @@index([userId, startedAt], map: "idx_focus_sessions_user_id_started_at")
  @@map("focus_sessions")
}

/// ğŸ“‹ í¬ì¸íŠ¸ ê¸°ë¡ í…Œì´ë¸”
model PointLog {
  id      String @id @default(uuid()) @db.Uuid
  studyId String @map("study_id") @db.Uuid
  userId  String @map("user_id") @db.Uuid

  delta Int

  // í™•ì¥ì„±ì„ ì´ìœ ë¡œ ì¡´ì¬
  /// ë°œìƒ ê·¼ê±° í…Œì´ë¸” íƒ€ì… (ì˜ˆ: FOCUS_SESSION)
  referenceType String @map("reference_type") @db.VarChar(50)
  /// ë°œìƒ ê·¼ê±° í…Œì´ë¸”ì˜ ID
  referenceId   String @map("reference_id") @db.Uuid
  /// í¬ì¸íŠ¸ ë°œìƒ ì‚¬ìœ  (ì˜ˆ: ì§‘ì¤‘ ì™„ë£Œ ë³´ë„ˆìŠ¤) 
  reason        String @db.VarChar(100)

  createdAt DateTime @default(now()) @map("created_at")

  // ê´€ê³„
  study Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([studyId, createdAt], map: "idx_point_logs_study_id_created_at")
  @@index([userId, createdAt], map: "idx_point_logs_user_id_created_at")
  @@map("point_logs")
}

/// ğŸ“‹ ì´ëª¨ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ í…Œì´ë¸”
model EmojiCatalog {
  id               String @id @default(uuid()) @db.Uuid
  emojiUnifiedCode String @map("emoji_unified_code") @db.VarChar(50)

  createdAt DateTime @default(now()) @map("created_at")

  // ê´€ê³„
  studyEmojiReactions StudyEmojiReaction[]

  @@unique([emojiUnifiedCode], map: "uq_emoji_catalog_emoji_unified_code")
  @@map("emoji_catalog")
}

/// ğŸ“‹ ìŠ¤í„°ë”” ì´ëª¨ì§€ ë°˜ì‘ í…Œì´ë¸”
model StudyEmojiReaction {
  id      String @id @default(uuid()) @db.Uuid
  studyId String @map("study_id") @db.Uuid
  userId  String @map("user_id") @db.Uuid
  emojiId String @map("emoji_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  // ê´€ê³„
  study Study        @relation(fields: [studyId], references: [id], onDelete: Cascade)
  user  User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji EmojiCatalog @relation(fields: [emojiId], references: [id], onDelete: Cascade)

  @@index([studyId, createdAt], map: "idx_study_emoji_reactions_study_id_created_at")
  @@index([emojiId], map: "idx_study_emoji_reactions_emoji_id")
  @@map("study_emoji_reactions")
}

/// ğŸ“‹ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ í…Œì´ë¸”
model Post {
  id       String @id @default(uuid()) @db.Uuid
  authorId String @map("author_id") @db.Uuid

  title   String @db.VarChar(100)
  content String @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // ê´€ê³„
  author       User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  postLikes    PostLike[]
  postComments PostComment[]

  @@index([authorId, createdAt], map: "idx_posts_author_id_created_at")
  @@map("posts")
}

/// ğŸ“‹ ê²Œì‹œê¸€ ì¢‹ì•„ìš” í…Œì´ë¸”
model PostLike {
  id     String @id @default(uuid()) @db.Uuid
  postId String @map("post_id") @db.Uuid
  userId String @map("user_id") @db.Uuid

  createdAt DateTime @default(now()) @map("created_at")

  // ê´€ê³„
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId], map: "uq_post_likes_post_id_user_id")
  @@index([userId], map: "idx_post_likes_user_id")
  @@map("post_likes")
}

/// ğŸ“‹ ê²Œì‹œê¸€ ëŒ“ê¸€ í…Œì´ë¸”
model PostComment {
  id       String @id @default(uuid()) @db.Uuid
  postId   String @map("post_id") @db.Uuid
  authorId String @map("author_id") @db.Uuid

  content String @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // ê´€ê³„
  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt], map: "idx_post_comments_post_id_created_at")
  @@map("post_comments")
}

/// ğŸ“‹ ìŠ¤í„°ë”” ëŒ“ê¸€ í…Œì´ë¸”
model StudyComment {
  id       String @id @default(uuid()) @db.Uuid
  studyId  String @map("study_id") @db.Uuid
  authorId String @map("author_id") @db.Uuid

  content String @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // ê´€ê³„
  study  Study @relation(fields: [studyId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([studyId, createdAt], map: "idx_study_comments_study_id_created_at")
  @@map("study_comments")
}